# Техническая документация по серверу Майнкрафта

Сервер крутится в [AWS EC2](https://aws.amazon.com/ec2/) в инстансе _t3a.medium_:

- [Amazon Linux 2](https://aws.amazon.com/amazon-linux-2/)
- 2-thread 2.5 GHz
- 4 GB RAM
- 100 GB SSD
- Физически мы в зоне _eu-central-1a_, во Франкфурте

Мир весит 600 MB, веб-карта – 12 GB. Плюс 10 бэкапов мира. Места должно хватить надолго.

Биллинг AWS идёт в сторону @deltaidea.

## Рендер карты

Достаточно написать в чате в игре: `--render-map` и подождать. В чате должны появляться логи.
Если нет никакого отклика, проверь сервер (`screen -ls` должно иметь `minecraft_watch_commands` в списке) или напиши в Trello.

Рендер занимает 10 минут. Работает этот скрипт так:

- Создаёт новый, гораздо более мощный инстанс (через API AWS).
- Делает бэкап мира и кидает его в инстанс для рендера.
- Устанавливает там Overviewer и качает туда конфиг из https://github.com/dq-server/overviewer-config
- Рендерит карту (это самый долгий шаг)
- Копирует её по сети обратно на инстанс с Майнкрафтом
- Уничтожает инстанс для рендера, чтобы не тратить деньги

## Включение и выключение сервера

- Чтобы безопасно выключить инстанс, напиши в чате: `--system-shutdown`.
- Чтобы включить сервер обратно, зайди на https://manage.minecraft.deltaidea.com и введи ключ из Trello.

## Бэкапы

Мир бэкапится каждый час в соседнюю папку прямо на инстансе. Хранятся только последние 10 бэкапов.

Возможно, стоит настроить бэкапы в AWS S3, но пока их нету.

Чтобы восстановиться из бэкапа, нужно залогиниться в инстанс (`ssh -i ~/.ssh/minecraft-ec2.pem ec2-user@minecraft.deltaidea.com`) и выполнить:

```sh
# Look at the dates and choose a suitable backup
ls -lhAF ~/minecraft-backups
# Change the argument to the backup number, in this case we're using backup-5
~/scripts/minecraft_restore.sh 5
```

Можно скачать себе последний бэкап, если хочется. Нужно выполнить это на своей машине:

```sh
scp -r -i ~/.ssh/minecraft-ec2.pem ec2-user@minecraft.deltaidea.com:~/minecraft-backups/backup-0 ./world-backup
```

P.S. Ключ `minecraft-ec2.pem` приложен в Trello.

## Крон и автозапуск после ребута

На сервере есть три сервиса systemctl: для Майнкрафта, для HTTP сервера карты, для DynDNS. Они все сами запускаются после ребута.

Сервис `minecraft.service` спавнит ещё один процесс для прослушки логов чата, чтобы откликаться на наши кастомные команды.

Есть два правила crontab: каждый час делать бэкап мира и два раза в сутки пытаться обновить сертификат SSL от LetsEncrypt для нашего мелкого API. См. описание ниже и выше и конкретный код в `./system_init_instance.sh`.

## HTTP Management API

На сервере крутится примитивный самодельный HTTP сервер `management_api.py`. Он висит в автозапуске как сервис `systemctl`, см. `management_api.service`.

Этот HTTP сервер используется в [manage.minecraft.deltaidea.com](https://manage.minecraft.deltaidea.com), чтобы узнавать статус Майнкрафта. Общаться с сервером Майнкрафта можно только голыми TCP пакетами, а в браузере JavaScript может посылать только пакеты в обёртке HTTP или WebSockets. Раз домен `minecraft.deltaidea.com` прокинут на машину с Майнкрафтом ради самой игры, мы просто запускаем API на соседнем порту: https://minecraft.deltaidea.com:5000.

Есть два ендпоинта:

- `GET /minecraft-status` возвращает JSON с версией игры и списком игроков. Под капотом вызывает `./minecraft_get_status.sh`.
- `GET /map-status` возвращает `{"status": 200}` на основе запроса к файлу `127.0.0.1/overviewer.js`, который должен существовать, если на сервере запущен HTTP сервер карты.

Никакой аутентификации пока нету, хотя было бы неплохо прикрутить ради потенциальных кнопок рендера карты и выключения машины.

### SSL

Так как [manage.minecraft.deltaidea.com](https://manage.minecraft.deltaidea.com) открывается по HTTPS, из JS на той странице нельзя делать нешифрованные запросы. Соответственно, чтобы стучаться в Management API, последнему нужен валидный SSL сертификат. Для этого используется [Let's Encrypt](https://letsencrypt.org). **Перед переездом нужно обязательно сделать бэкап папки `/etc/letsencrypt`.** Так было сказано при первой установке их CLI. Наверняка без бэкапа будет сложно или невозможно сгенерить новый сертификат для того же домена.

## Запуск инстанса с нуля

Если придётся поменять тип инстанса или зону хостинга, или вовсе съехать из AWS, иструкция по переезду в [migration_guide.md](migration_guide.md)
